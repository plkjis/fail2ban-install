#!/bin/bash

# ==============================================================================
#
#          Modern Fail2ban Installer for Debian-based Systems (Robust Version)
#
# ==============================================================================

# --- Color Definitions for better user feedback ---
C_RESET='\033[0m'
C_RED='\033[0;31m'
C_GREEN='\033[0;32m'
C_YELLOW='\033[0;33m'
C_BLUE='\033[0;34m'

# --- Step 1: Ensure the script is run as root ---
if [ "$(id -u)" -ne 0 ]; then
  echo -e "${C_RED}错误: 此脚本必须以 root 权限运行。${C_RESET}"
  echo -e "${C_YELLOW}请尝试使用 'sudo bash $0' 来执行。${C_RESET}"
  exit 1
fi

# --- Step 2: Gather user-defined settings ---
echo -e "${C_BLUE}--- Fail2ban SSH 保护配置 ---${C_RESET}"

# Detect current SSH port from sshd_config
current_ssh_port=$(grep -i '^Port' /etc/ssh/sshd_config | awk '{print $2}' | head -n 1)
[ -z "$current_ssh_port" ] && current_ssh_port=22

read -p "请输入您的 SSH 端口 (默认为: ${current_ssh_port}): " ssh_port
ssh_port=${ssh_port:-${current_ssh_port}}

read -p "请输入最大登录重试次数 (2-10, 默认为 3): " maxretry
maxretry=${maxretry:-3}

read -p "请输入封禁 IP 的时长 (单位: 小时, 默认为 24): " bantime_hours
bantime_hours=${bantime_hours:-24}

bantime_seconds=$((bantime_hours * 3600))

echo "----------------------------------------"
echo -e "${C_YELLOW}配置摘要:${C_RESET}"
echo "  SSH 端口: ${ssh_port}"
echo "  最大重试次数: ${maxretry}"
echo "  封禁时长: ${bantime_hours} 小时 (${bantime_seconds} 秒)"
echo "----------------------------------------"
read -p "确认以上配置并继续安装吗? (y/n): " confirm
if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
    echo -e "${C_RED}安装已取消。${C_RESET}"
    exit 0
fi

# --- Step 3: Install Fail2ban ---
echo -e "\n${C_BLUE}>>> 正在更新软件包列表并安装 Fail2ban...${C_RESET}"
apt-get update
apt-get install -y fail2ban

# --- Step 4: Create the modern configuration file ---
CONFIG_FILE="/etc/fail2ban/jail.d/sshd-custom.local"
echo -e "${C_BLUE}>>> 正在创建配置文件: ${CONFIG_FILE}${C_RESET}"

cat <<EOF > "${CONFIG_FILE}"
# This file was generated by a setup script.
[sshd]
enabled = true
# [MODIFICATION] Tell Fail2ban to read logs directly from the systemd journal
# This avoids the need for rsyslog and /var/log/auth.log
backend = systemd
port    = ${ssh_port}
maxretry = ${maxretry}
bantime = ${bantime_seconds}s
EOF

# --- Step 5: Test configuration and restart the service ---
# We can skip the 'fail2ban-client -d' test as it can be unreliable without a running server.
# A direct restart and status check is more robust.
echo -e "${C_BLUE}>>> 正在启用并重启 Fail2ban 服务...${C_RESET}"
systemctl enable fail2ban
systemctl restart fail2ban

# --- Step 6: Verify the installation and provide feedback ---
echo -e "\n${C_BLUE}>>> 正在验证服务状态...${C_RESET}"
sleep 2

if systemctl is-active --quiet fail2ban; then
  echo -e "${C_GREEN}✔ Fail2ban 安装并配置成功！服务正在运行中。${C_RESET}"
  echo -e "\n${C_YELLOW}您可以使用以下命令随时查看 SSH 防护的状态:${C_RESET}"
  echo -e "  sudo fail2ban-client status sshd"
else
  echo -e "${C_RED}✖ 错误: Fail2ban 服务启动失败。${C_RESET}"
  echo -e "${C_YELLOW}请使用以下命令查看详细的错误日志:${C_RESET}"
  echo -e "  journalctl -u fail2ban -n 50"
  echo -e "${C_YELLOW}或运行 'fail2ban-server -f' 进行实时调试。${C_RESET}"
  exit 1
fi

echo -e "\n${C_GREEN}安装完成！您的 SSH 服务现在已受到 Fail2ban 的保护。${C_RESET}"
